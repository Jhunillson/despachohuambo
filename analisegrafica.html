<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>An√°lise Gr√°fica - Despacho Huambo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f8f8;
      color: #000;
    }
    
    .header {
      text-align: center;
      background: linear-gradient(135deg, #dc143c, #8b0000);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .header h1 {
      margin: 0;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
    }
    
    .header p {
      margin: 10px 0 0 0;
      font-size: clamp(0.9rem, 2vw, 1.1rem);
      opacity: 0.9;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 30px;
      justify-content: center;
      align-items: center;
    }
    
    button {
      background: linear-gradient(135deg, #dc143c, #8b0000);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      font-size: clamp(0.8rem, 2vw, 1rem);
    }
    
    button:hover {
      background: linear-gradient(135deg, #b71c1c, #8b0000);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }
    
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 2px solid #333;
      height: 400px;
      position: relative;
    }
    
    .chart-container canvas {
      max-height: 300px !important;
      width: 100% !important;
    }
    
    .chart-title {
      text-align: center;
      color: #8b0000;
      font-size: clamp(1rem, 3vw, 1.3rem);
      font-weight: bold;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #dc143c;
    }
    
    .summary-chart {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #fff, #ffebee);
      height: 450px;
    }
    
    .summary-chart canvas {
      max-height: 350px !important;
    }
    
    .no-data {
      text-align: center;
      padding: 50px;
      color: #666;
      font-style: italic;
      background: white;
      border-radius: 10px;
      border: 2px solid #dc143c;
    }
    
    .stats-info {
      background: linear-gradient(135deg, #ffebee, #ffcdd2);
      border: 2px solid #dc143c;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }
    
    .stats-info h3 {
      color: #8b0000;
      margin: 0 0 10px 0;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .chart-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .chart-container {
        padding: 15px;
        height: 350px;
      }
      
      .chart-container canvas {
        max-height: 250px !important;
      }
      
      .summary-chart {
        height: 400px;
      }
      
      .summary-chart canvas {
        max-height: 300px !important;
      }
      
      .controls {
        flex-direction: column;
        gap: 10px;
      }
      
      button {
        width: 100%;
        max-width: 300px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .header {
        padding: 15px;
        margin-bottom: 20px;
      }
      
      .chart-container {
        padding: 10px;
        height: 300px;
      }
      
      .chart-container canvas {
        max-height: 200px !important;
      }
      
      .summary-chart {
        height: 350px;
      }
      
      .summary-chart canvas {
        max-height: 250px !important;
      }
      
      .chart-grid {
        gap: 15px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>üìä An√°lise Gr√°fica - Despacho Huambo</h1>
    <p>Visualiza√ß√£o das Situa√ß√µes Operativas Gravadas</p>
  </div>

  <div class="controls">
    <button onclick="voltarPagina()">‚Üê Voltar ao Despacho</button>
    <button onclick="atualizarGraficos()">üîÑ Atualizar Gr√°ficos</button>
    <button onclick="exportarDados()">üíæ Exportar Dados</button>
  </div>

  <div class="stats-info" id="statsInfo">
    <!-- Informa√ß√µes estat√≠sticas ser√£o inseridas aqui -->
  </div>

  <div class="chart-grid" id="chartsContainer">
    <!-- Gr√°ficos ser√£o inseridos aqui -->
  </div>

  <script>
    const localidades = [
      "Huambo", "Ca√°la", "Bailundo", "Longonjo", "Londuimbali", 
      "Catchiungo", "Chicala-Choloanga", "Chinjenje"
    ];

    const coresLocalidades = [
      '#dc143c', '#8b0000', '#ff6b6b', '#d32f2f',
      '#c62828', '#b71c1c', '#ff5722', '#e64a19'
    ];

    let chartInstances = [];

    function voltarPagina() {
      window.close();
      // Se n√£o conseguir fechar, tentar navegar de volta
      if (!window.closed) {
        window.history.back();
      }
    }

    function carregarDados() {
      const situacoes = JSON.parse(localStorage.getItem('situacoesOperativas') || '[]');
      
      if (situacoes.length === 0) {
        document.getElementById('chartsContainer').innerHTML = `
          <div class="no-data">
            <h2>üìä Nenhum dado encontrado</h2>
            <p>N√£o existem situa√ß√µes operativas gravadas.</p>
            <p>Volte para a p√°gina principal e grave pelo menos uma situa√ß√£o para visualizar os gr√°ficos.</p>
          </div>
        `;
        document.getElementById('statsInfo').innerHTML = '';
        return [];
      }

      // Atualizar informa√ß√µes estat√≠sticas
      const ultimaSituacao = situacoes[situacoes.length - 1];
      document.getElementById('statsInfo').innerHTML = `
        <h3>üìà Estat√≠sticas dos Dados</h3>
        <p><strong>Total de registros:</strong> ${situacoes.length} | 
           <strong>√öltima atualiza√ß√£o:</strong> ${ultimaSituacao.data} √†s ${ultimaSituacao.hora}</p>
      `;

      return situacoes;
    }

    function gerarGraficos() {
      const situacoes = carregarDados();
      if (situacoes.length === 0) return;

      // Limpar gr√°ficos existentes
      chartInstances.forEach(chart => chart.destroy());
      chartInstances = [];

      const container = document.getElementById('chartsContainer');
      container.innerHTML = '';

      // Gr√°fico resumo de todas as localidades (√∫ltima situa√ß√£o)
      criarGraficoResumo(container, situacoes);

      // Gr√°ficos individuais por localidade
      localidades.forEach((localidade, index) => {
        criarGraficoLocalidade(container, situacoes, localidade, index);
      });
    }

    function criarGraficoResumo(container, situacoes) {
      const ultimaSituacao = situacoes[situacoes.length - 1];
      
      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart-container summary-chart';
      chartDiv.innerHTML = `
        <div class="chart-title">üìä Resumo Geral - Todas as Localidades (${ultimaSituacao.data} - ${ultimaSituacao.hora})</div>
        <canvas id="resumoChart"></canvas>
      `;
      container.appendChild(chartDiv);

      const labels = [];
      const demandaData = [];
      const utilizadaData = [];

      localidades.forEach(localidade => {
        const dados = ultimaSituacao.localidades[localidade];
        if (dados && dados.demanda > 0) {
          labels.push(localidade);
          demandaData.push(dados.demanda);
          utilizadaData.push(dados.utilizada);
        }
      });

      const ctx = document.getElementById('resumoChart').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Demanda (MW)',
              data: demandaData,
              backgroundColor: 'rgba(220, 20, 60, 0.7)',
              borderColor: '#dc143c',
              borderWidth: 2
            },
            {
              label: 'Pot√™ncia Utilizada (MW)',
              data: utilizadaData,
              backgroundColor: 'rgba(139, 0, 0, 0.7)',
              borderColor: '#8b0000',
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          aspectRatio: 2,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Pot√™ncia (MW)',
                color: '#333',
                font: { weight: 'bold', size: 12 }
              },
              ticks: {
                font: { size: 10 }
              }
            },
            x: {
              ticks: {
                font: { size: 9 },
                maxRotation: 45
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: { size: 11 },
                boxWidth: 15,
                padding: 10
              }
            }
          }
        }
      });
      chart.canvas.style.height = '300px';
      chart.canvas.style.maxHeight = '300px';
      chart.resize();
      chartInstances.push(chart);
    }

    function criarGraficoLocalidade(container, situacoes, localidade, index) {
      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart-container';
      chartDiv.innerHTML = `
        <div class="chart-title">‚ö° ${localidade}</div>
        <canvas id="chart${index}"></canvas>
      `;
      container.appendChild(chartDiv);

      const labels = [];
      const demandaData = [];
      const utilizadaData = [];
      const restricoesData = [];
      const avariasData = [];

      // Pegar √∫ltimas 10 situa√ß√µes ou todas se forem menos
      const ultimasSituacoes = situacoes.slice(-10);
      
      ultimasSituacoes.forEach(situacao => {
        const dados = situacao.localidades[localidade];
        if (dados) {
          labels.push(`${situacao.data}\n${situacao.hora}`);
          demandaData.push(dados.demanda);
          utilizadaData.push(dados.utilizada);
          restricoesData.push(dados.restrMT + dados.restrBT);
          avariasData.push(dados.avariaMT + dados.avariaBT);
        }
      });

      if (labels.length === 0) {
        chartDiv.innerHTML = `
          <div class="chart-title">‚ö° ${localidade}</div>
          <div style="padding: 20px; text-align: center; color: #666;">
            Sem dados dispon√≠veis para esta localidade
          </div>
        `;
        return;
      }

      const ctx = document.getElementById(`chart${index}`).getContext('2d');
      const cor = coresLocalidades[index % coresLocalidades.length];
      
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Demanda',
              data: demandaData,
              borderColor: cor,
              backgroundColor: cor + '20',
              fill: false,
              tension: 0.1,
              borderWidth: 3
            },
            {
              label: 'Pot√™ncia Utilizada',
              data: utilizadaData,
              borderColor: '#000',
              backgroundColor: 'rgba(0,0,0,0.1)',
              fill: false,
              tension: 0.1,
              borderWidth: 2
            },
            {
              label: 'Total Restri√ß√µes',
              data: restricoesData,
              borderColor: '#ff9800',
              backgroundColor: 'rgba(255,152,0,0.1)',
              fill: false,
              tension: 0.1,
              borderWidth: 2,
              borderDash: [5, 5]
            },
            {
              label: 'Total Avarias',
              data: avariasData,
              borderColor: '#f44336',
              backgroundColor: 'rgba(244,67,54,0.1)',
              fill: false,
              tension: 0.1,
              borderWidth: 2,
              borderDash: [10, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          aspectRatio: 1.8,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Pot√™ncia (MW)',
                color: '#333',
                font: { weight: 'bold', size: 11 }
              },
              ticks: {
                font: { size: 9 }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Data/Hora',
                color: '#333',
                font: { weight: 'bold', size: 11 }
              },
              ticks: {
                font: { size: 8 },
                maxRotation: 45,
                callback: function(value, index) {
                  // Mostrar apenas alguns labels para evitar sobreposi√ß√£o
                  return index % 2 === 0 ? this.getLabelForValue(value) : '';
                }
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: { size: 10 },
                boxWidth: 12,
                padding: 8
              }
            }
          }
        }
      });
      chart.canvas.style.height = '250px';
      chart.canvas.style.maxHeight = '250px';
      chart.resize();
      chartInstances.push(chart);
    }

    function atualizarGraficos() {
      gerarGraficos();
      alert('Gr√°ficos atualizados com sucesso!');
    }

    function exportarDados() {
      const situacoes = JSON.parse(localStorage.getItem('situacoesOperativas') || '[]');
      
      if (situacoes.length === 0) {
        alert('N√£o existem dados para exportar.');
        return;
      }

      // Preparar dados para CSV
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Data,Hora,Localidade,Demanda(MW),Potencia_Utilizada(MW),Restricao_MT(MW),Restricao_BT(MW),Avaria_MT(MW),Avaria_BT(MW),Grau_Atendimento(%)\n";

      situacoes.forEach(situacao => {
        localidades.forEach(localidade => {
          const dados = situacao.localidades[localidade];
          if (dados && dados.demanda > 0) {
            const grau = (dados.demanda === 0) ? 0 : ((dados.utilizada / dados.demanda) * 100).toFixed(2);
            csvContent += `${situacao.data},${situacao.hora},${localidade},${dados.demanda},${dados.utilizada},${dados.restrMT},${dados.restrBT},${dados.avariaMT},${dados.avariaBT},${grau}\n`;
          }
        });
      });

      // Download do arquivo
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `despacho_huambo_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Executar quando a p√°gina carregar
    window.addEventListener('load', function() {
      gerarGraficos();
    });
  </script>
</body>
</html>